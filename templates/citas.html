{% extends "base.html" %}

{% block title %}Citas - Healthy Feet{% endblock %}

{% block content %}
<div class="content-header">
    <div class="d-flex justify-between align-center">
        <div>
            <h1 class="content-title">
                <i class="fas fa-calendar-check"></i>
                Gestión de Citas
            </h1>
            <p class="content-subtitle">Administra las citas del día</p>
        </div>
        
        <div class="d-flex align-center gap-3">
            <div class="user-info">
                <span class="text-primary">{{ current_user.nombre }}</span>
                <span class="text-muted">• {{ current_user.email }}</span>
            </div>
            <button class="btn btn-outline btn-sm" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</div>

<div class="citas-header">
    <div class="date-selector">
        <i class="fas fa-calendar-alt text-primary"></i>
        <form method="GET" action="{{ url_for('citas') }}" class="d-flex align-center gap-2">
            <input type="date" 
                   name="fecha" 
                   value="{{ fecha_actual }}" 
                   class="form-control"
                   onchange="this.form.submit()"
                   style="width: auto;">
        </form>
    </div>
    
    <button class="btn btn-success" id="toggle-form">
        <i class="fas fa-plus"></i> Nueva Cita
    </button>
</div>

<!-- Formulario Nueva Cita (oculto por defecto) -->
<div id="new-cita-form" class="container-card d-none">
    <h3 class="mb-3"><i class="fas fa-calendar-plus"></i> Agendar Nueva Cita</h3>
    <form method="POST" action="{{ url_for('agregar_cita') }}">
        <div class="grid grid-2 gap-3">
            <div class="form-group">
                <label for="cliente" class="form-label">Cliente</label>
                <input list="clientes-list" 
                       id="cliente" 
                       name="cliente" 
                       class="form-control" 
                       placeholder="Escribe o selecciona un cliente" 
                       required>
                <datalist id="clientes-list">
                    {% for c in clientes %}
                        <option value="{{ c.nombre }}"></option>
                    {% endfor %}
                </datalist>
            </div>
            
            <div class="form-group">
                <label for="telefono" class="form-label">Teléfono</label>
                <input type="tel" 
                       id="telefono" 
                       name="telefono" 
                       class="form-control" 
                       placeholder="10 dígitos" 
                       required
                       pattern="\d{10}"
                       maxlength="10">
            </div>
            
            <div class="form-group">
                <label for="servicio" class="form-label">Servicio</label>
                <select id="servicio" name="servicio" class="form-control" required>
                    <option value="">Seleccionar servicio...</option>
                    {% for s in servicios %}
                        <option value="{{ s.id }}">{{ s.nombre_servicio }} (${{ s.precio }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="empleado" class="form-label">Empleado</label>
                <select id="empleado" name="empleado" class="form-control" required>
                    <option value="">Seleccionar empleado...</option>
                    {% for e in empleados %}
                        <option value="{{ e.id }}">{{ e.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="fecha" class="form-label">Fecha</label>
                <input type="date" 
                       id="fecha" 
                       name="fecha" 
                       class="form-control" 
                       value="{{ fecha_actual }}" 
                       required>
            </div>
            
            <div class="form-group">
                <label for="hora" class="form-label">Hora</label>
                <input type="time" 
                       id="hora" 
                       name="hora" 
                       class="form-control" 
                       required
                       min="09:00"
                       max="20:00"
                       step="900">
            </div>
        </div>
        
        <div class="d-flex justify-center gap-3 mt-4">
            <button type="button" class="btn btn-outline" id="cancel-form">Cancelar</button>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Guardar Cita
            </button>
        </div>
    </form>
</div>

<!-- Lista de Citas del Día -->
<div class="container-card">
    <h3 class="mb-4">
        <i class="fas fa-calendar-day"></i> 
        Citas del {{ fecha_actual|format_date }}
        <span class="badge badge-primary">{{ citas_dia|length }}</span>
    </h3>
    
    {% if citas_dia %}
    <div class="citas-grid">
        {% for cita in citas_dia %}
        <div class="cita-card">
            <div class="d-flex justify-between align-center mb-3">
                <h4 class="text-primary">{{ cita.nombre_cliente }}</h4>
                <span class="badge badge-success">{{ cita.hora|format_time }}</span>
            </div>
            
            <div class="cita-details">
                <p class="empleado-info">
                    <i class="fas fa-user-md text-primary"></i>
                    <strong>Empleado:</strong> {{ cita.nombre_empleado }}
                </p>
                <p class="empleado-info">
                    <i class="fas fa-spa text-primary"></i>
                    <strong>Servicio:</strong> {{ cita.nombre_servicio }}
                </p>
                <p class="empleado-info">
                    <i class="fas fa-phone text-primary"></i>
                    <strong>Teléfono:</strong> {{ cita.telefono }}
                </p>
                <p class="empleado-info">
                    <i class="fas fa-money-bill text-primary"></i>
                    <strong>Precio:</strong> ${{ cita.precio }}
                </p>
                <p class="empleado-info">
                    <i class="fas fa-info-circle text-primary"></i>
                    <strong>Estado:</strong> 
                    {% if cita.estado == 'finalizada' %}
                        <span class="badge badge-success">Finalizada</span>
                    {% elif cita.estado == 'cancelada' %}
                        <span class="badge badge-danger">Cancelada</span>
                    {% elif cita.estado == 'confirmada' %}
                        <span class="badge badge-info">Confirmada</span>
                    {% else %}
                        <span class="badge badge-warning">Pendiente</span>
                    {% endif %}
                </p>
            </div>
            
            <div class="cita-actions">
                <form method="GET" action="{{ url_for('editar_cita') }}" class="d-inline">
                    <input type="hidden" name="id" value="{{ cita.id }}">
                    <button type="submit" class="btn btn-outline btn-sm">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </form>
                
                {% if cita.estado != 'finalizada' and cita.estado != 'cancelada' %}
                <button type="button" 
                        class="btn btn-success btn-sm finalizar-cita-btn" 
                        data-cita-id="{{ cita.id }}"
                        data-cita-cliente="{{ cita.nombre_cliente }}"
                        data-cita-fecha="{{ cita.fecha }}"
                        data-cita-hora="{{ cita.hora }}">
                    <i class="fas fa-check-circle"></i> Finalizar
                </button>

                <button type="button"
                        class="btn btn-danger btn-sm cancelar-cita-btn"
                        data-cita-id="{{ cita.id }}"
                        data-cita-cliente="{{ cita.nombre_cliente }}"
                        data-cita-fecha="{{ cita.fecha }}"
                        data-cita-hora="{{ cita.hora }}">
                    <i class="fas fa-times-circle"></i> Cancelar
                </button>
                {% elif cita.estado == 'finalizada' %}
                <button class="btn btn-success btn-sm" disabled>
                    <i class="fas fa-check-circle"></i> Finalizada
                </button>
                {% elif cita.estado == 'cancelada' %}
                <button class="btn btn-secondary btn-sm" disabled>
                    <i class="fas fa-ban"></i> Cancelada
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center p-4">
        <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
        <h5 class="text-muted">No hay citas para esta fecha</h5>
        <p class="text-muted small">Agenda una nueva cita haciendo clic en "Nueva Cita"</p>
    </div>
    {% endif %}
</div>

<script>
// Mostrar/ocultar formulario nueva cita
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggle-form');
    const cancelBtn = document.getElementById('cancel-form');
    const formContainer = document.getElementById('new-cita-form');
    
    toggleBtn.addEventListener('click', function() {
        formContainer.classList.toggle('d-none');
        toggleBtn.innerHTML = formContainer.classList.contains('d-none') 
            ? '<i class="fas fa-plus"></i> Nueva Cita' 
            : '<i class="fas fa-times"></i> Cancelar';
        toggleBtn.classList.toggle('btn-success');
        toggleBtn.classList.toggle('btn-outline');
    });
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            formContainer.classList.add('d-none');
            toggleBtn.innerHTML = '<i class="fas fa-plus"></i> Nueva Cita';
            toggleBtn.classList.add('btn-success');
            toggleBtn.classList.remove('btn-outline');
        });
    }
    
    // Validación de teléfono en tiempo real
    const telefonoInput = document.getElementById('telefono');
    if (telefonoInput) {
        telefonoInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '').slice(0, 10);
        });
    }
    
    // Formatear hora automáticamente en input time
    const horaInput = document.getElementById('hora');
    if (horaInput) {
        horaInput.addEventListener('change', function(e) {
            // Asegurar que sea en intervalos de 15 minutos
            const time = this.value.split(':');
            if (time.length === 2) {
                const minutes = parseInt(time[1]);
                const roundedMinutes = Math.round(minutes / 15) * 15;
                time[1] = roundedMinutes.toString().padStart(2, '0');
                this.value = time.join(':');
            }
        });
    }
});

// Confirmación para finalizar cita
document.addEventListener('DOMContentLoaded', function() {
    const finalizarBtns = document.querySelectorAll('.finalizar-cita-btn');
    
    finalizarBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const citaId = this.getAttribute('data-cita-id');
            const cliente = this.getAttribute('data-cita-cliente');
            const fecha = this.getAttribute('data-cita-fecha');
            const hora = this.getAttribute('data-cita-hora');
            
            // Formatear fecha
            const fechaFormateada = new Date(fecha).toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Formatear hora
            const horaFormateada = new Date(`2000-01-01T${hora}`).toLocaleTimeString('es-MX', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Mostrar SweetAlert o confirm nativo
            if (typeof Swal !== 'undefined') {
                // Usar SweetAlert si está disponible
                Swal.fire({
                    title: '¿Finalizar Cita?',
                    html: `
                        <div class="text-left">
                            <p><strong>Cliente:</strong> ${cliente}</p>
                            <p><strong>Fecha:</strong> ${fechaFormateada}</p>
                            <p><strong>Hora:</strong> ${horaFormateada}</p>
                            <p class="text-danger mt-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>¡ATENCIÓN!</strong> Una vez finalizada, no podrás editar esta cita.
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, finalizar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Crear formulario dinámico para enviar
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = "{{ url_for('finalizar_cita') }}";
                        
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'id_cita';
                        input.value = citaId;
                        
                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            } else {
                // Usar confirm nativo
                const mensaje = `¿Estás seguro que deseas finalizar la cita de ${cliente}?\n\n` +
                              `Fecha: ${fechaFormateada}\n` +
                              `Hora: ${horaFormateada}\n\n` +
                              `⚠️ ¡ATENCIÓN! Una vez finalizada, no podrás editar esta cita.`;
                
                if (confirm(mensaje)) {
                    // Crear formulario dinámico
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = "{{ url_for('finalizar_cita') }}";
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'id_cita';
                    input.value = citaId;
                    
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        });
    });
});

// Confirmación para cancelar cita
document.addEventListener('DOMContentLoaded', function() {
    const cancelarBtns = document.querySelectorAll('.cancelar-cita-btn');
    
    cancelarBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const citaId = this.getAttribute('data-cita-id');
            const cliente = this.getAttribute('data-cita-cliente');
            const fecha = this.getAttribute('data-cita-fecha');
            const hora = this.getAttribute('data-cita-hora');
            
            // Formatear fecha
            const fechaFormateada = new Date(fecha).toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Formatear hora
            const horaFormateada = new Date(`2000-01-01T${hora}`).toLocaleTimeString('es-MX', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Mostrar confirmación
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: '¿Cancelar Cita?',
                    html: `
                        <div class="text-left">
                            <p><strong>Cliente:</strong> ${cliente}</p>
                            <p><strong>Fecha:</strong> ${fechaFormateada}</p>
                            <p><strong>Hora:</strong> ${horaFormateada}</p>
                            <p class="text-danger mt-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>¡ATENCIÓN!</strong> Esta acción no se puede deshacer.
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, cancelar',
                    cancelButtonText: 'Volver'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Crear formulario para cancelar
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = "{{ url_for('cancelar_cita') }}";
                        
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'id_cita';
                        input.value = citaId;
                        
                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            } else {
                const mensaje = `¿Estás seguro que deseas cancelar la cita de ${cliente}?\n\n` +
                              `Fecha: ${fechaFormateada}\n` +
                              `Hora: ${horaFormateada}\n\n` +
                              `⚠️ ¡ATENCIÓN! Esta acción no se puede deshacer.`;
                
                if (confirm(mensaje)) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = "{{ url_for('cancelar_cita') }}";
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'id_cita';
                    input.value = citaId;
                    
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        });
    });
});

// Deshabilitar botón de editar si la cita está finalizada o cancelada
document.addEventListener('DOMContentLoaded', function() {
    const citaCards = document.querySelectorAll('.cita-card');
    citaCards.forEach(card => {
        const estadoBadge = card.querySelector('.badge-success, .badge-danger');
        if (estadoBadge && (estadoBadge.textContent.includes('Finalizada') || estadoBadge.textContent.includes('Cancelada'))) {
            const editarBtn = card.querySelector('form[action*="editar_cita"] button');
            if (editarBtn) {
                editarBtn.disabled = true;
                editarBtn.classList.remove('btn-outline');
                editarBtn.classList.add('btn-secondary');
                if (estadoBadge.textContent.includes('Finalizada')) {
                    editarBtn.innerHTML = '<i class="fas fa-lock"></i> Finalizada';
                } else {
                    editarBtn.innerHTML = '<i class="fas fa-ban"></i> Cancelada';
                }
            }
            
            // También deshabilitar botones de finalizar/cancelar
            const finalizarBtn = card.querySelector('.finalizar-cita-btn');
            if (finalizarBtn) {
                finalizarBtn.disabled = true;
                finalizarBtn.classList.remove('btn-success');
                finalizarBtn.classList.add('btn-secondary');
            }
            
            const cancelarBtn = card.querySelector('.cancelar-cita-btn');
            if (cancelarBtn) {
                cancelarBtn.disabled = true;
                cancelarBtn.classList.remove('btn-danger');
                cancelarBtn.classList.add('btn-secondary');
            }
        }
    });
});

// Función para manejar conflictos de horarios (opcional)
function checkHorarioDisponible(id_empleado, fecha, hora, duracion, callback) {
    // Esta función podría implementarse para verificar disponibilidad en tiempo real
    fetch('/api/check_horario', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id_empleado: id_empleado,
            fecha: fecha,
            hora: hora,
            duracion: duracion
        })
    })
    .then(response => response.json())
    .then(data => {
        callback(data.disponible, data.mensaje);
    })
    .catch(error => {
        console.error('Error:', error);
        callback(false, 'Error al verificar horario');
    });
}
</script>
{% endblock %}